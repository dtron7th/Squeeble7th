<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID CARD AGE VERIFICATION SYSTEM v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <audio id="successBeep" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'VT323', monospace;
            background: #000000;
            color: #00ff00;
            overflow-y: auto;
            cursor: crosshair;
            min-height: 100vh;
        }
        
        .dos-container {
            width: 100%;
            min-height: 100vh;
            position: relative;
            background: #000000;
            display: flex;
            flex-direction: column;
        }
        
        .dos-header {
            background: #000080;
            color: #ffffff;
            padding: 10px;
            border-bottom: 2px solid #ffffff;
            font-size: 18px;
            text-align: center;
            animation: blink 1s infinite;
        }
        
        .dos-main {
            flex: 1;
            display: flex;
            padding: 10px;
            gap: 10px;
        }
        
        .dos-left {
            flex: 1;
            border: 2px solid #00ff00;
            background: #000000;
            padding: 10px;
            position: relative;
        }
        
        .dos-right {
            width: 400px;
            border: 2px solid #00ff00;
            background: #000000;
            padding: 10px;
            overflow-y: auto;
        }
        
        .dos-title {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ffff;
        }
        
        .dos-status {
            color: #ffff00;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .dos-controls {
            margin-bottom: 10px;
        }
        
        .dos-button {
            background: #000000;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 8px 16px;
            font-family: 'VT323', monospace;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s;
        }
        
        .dos-button:hover {
            background: #00ff00;
            color: #000000;
            box-shadow: 0 0 20px #00ff00;
        }
        
        .dos-button:disabled {
            color: #666666;
            border-color: #666666;
            cursor: not-allowed;
        }
        
        .dos-button:disabled:hover {
            background: #000000;
            color: #666666;
            box-shadow: none;
        }
        
        .mobile-controls {
            display: none;
            margin-bottom: 10px;
        }
        
        .mobile-btn {
            width: 100%;
            margin: 5px 0;
            font-size: 16px;
            min-height: 60px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .camera-tips {
            border: 1px solid #00ffff;
            background: #000033;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .tip-item {
            color: #00ffff;
            font-size: 14px;
            margin: 5px 0;
            padding-left: 10px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            height: 300px;
            border: 2px solid #00ff00;
            background: #000000;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        #canvas {
            display: none;
        }
        
        .dos-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #00ff00;
            font-size: 18px;
            text-align: center;
        }
        
        .dos-terminal {
            background: #000000;
            border: 1px solid #00ff00;
            padding: 10px;
            font-size: 14px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .dos-terminal::-webkit-scrollbar {
            width: 10px;
        }
        
        .dos-terminal::-webkit-scrollbar-track {
            background: #000000;
        }
        
        .dos-terminal::-webkit-scrollbar-thumb {
            background: #00ff00;
        }
        
        .age-result {
            border: 2px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            font-size: 20px;
        }
        
        .age-verified {
            background: #003300;
            color: #00ff00;
            border-color: #00ff00;
            animation: pulse 1s infinite;
        }
        
        .age-denied {
            background: #330000;
            color: #ff0000;
            border-color: #ff0000;
            animation: pulse 0.5s infinite;
        }
        
        .age-unknown {
            background: #333300;
            color: #ffff00;
            border-color: #ffff00;
        }
        
        .dos-info {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #00ffff;
            background: #000033;
        }
        
        .dos-info-item {
            margin: 5px 0;
            font-size: 16px;
        }
        
        .dos-label {
            color: #00ffff;
            display: inline-block;
            width: 150px;
        }
        
        .dos-value {
            color: #ffffff;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ff0000;
            top: 0;
            left: 0;
            animation: scan 2s linear infinite;
            box-shadow: 0 0 10px #ff0000;
            display: none;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background: #00ff00;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        
        .loading-text {
            color: #ffff00;
            animation: blink 0.5s infinite;
        }
        
        .error-text {
            color: #ff0000;
            animation: pulse 0.3s infinite;
        }
        
        .success-text {
            color: #00ff00;
            animation: pulse 1s infinite;
        }
        
        @media (max-width: 768px) {
            .dos-main {
                flex-direction: column;
            }
            
            .dos-right {
                width: 100%;
                height: 300px;
            }
            
            .dos-controls {
                display: none;
            }
            
            .mobile-controls {
                display: block;
            }
            
            .camera-tips {
                display: block !important;
            }
            
            .dos-button {
                font-size: 14px;
                padding: 12px 8px;
                margin: 3px;
                min-height: 50px;
                touch-action: manipulation;
            }
            
            .mobile-btn {
                font-size: 18px;
                min-height: 70px;
            }
            
            .dos-title {
                font-size: 18px;
            }
            
            .video-container {
                height: 250px;
            }
            
            .dos-terminal {
                font-size: 12px;
                height: 150px;
            }
            
            .age-result {
                font-size: 16px;
                padding: 10px;
            }
            
            .dos-info-item {
                font-size: 14px;
            }
            
            .dos-label {
                width: 100px;
                font-size: 12px;
            }
            
            .dos-value {
                font-size: 12px;
            }
            
            .dos-header {
                font-size: 14px;
                padding: 8px;
            }
            
            .tip-item {
                font-size: 16px;
                margin: 8px 0;
            }
        }
        
        @media (max-width: 480px) {
            .dos-button {
                font-size: 12px;
                padding: 10px 6px;
                min-height: 45px;
            }
            
            .mobile-btn {
                font-size: 16px;
                min-height: 60px;
            }
            
            .dos-title {
                font-size: 16px;
            }
            
            .video-container {
                height: 200px;
            }
            
            .dos-terminal {
                font-size: 11px;
                height: 120px;
            }
            
            .age-result {
                font-size: 14px;
                padding: 8px;
            }
            
            .dos-info-item {
                font-size: 12px;
            }
            
            .dos-header {
                font-size: 12px;
                padding: 6px;
            }
            
            .tip-item {
                font-size: 14px;
                margin: 6px 0;
            }
        }
    </style>
</head>
<body>
    <div class="dos-container">
        <div class="dos-header">
            ID CARD AGE VERIFICATION SYSTEM v1.0 - [C] Written by Daryle Walton JR
        </div>
        
        <div class="dos-main">
            <div class="dos-left">
                <div class="dos-title">> AGE VERIFICATION TERMINAL</div>
                <div class="dos-status">STATUS: <span id="status">READY</span><span class="cursor"></span></div>
                
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div class="scan-line" id="scanLine"></div>
                    <div class="dos-placeholder" id="placeholder">
                        <div>[ CAMERA OFFLINE ]</div>
                        <div>INITIALIZE SYSTEM TO BEGIN</div>
                    </div>
                </div>
                
                <div class="dos-controls">
                    <button class="dos-button" id="startBtn" onclick="startSystem()">[F1] INIT CAMERA</button>
                    <button class="dos-button" id="scanBtn" onclick="toggleScanning()" disabled>[F2] SCAN ID CARD</button>
                    <button class="dos-button" id="stopBtn" onclick="stopSystem()" disabled>[F3] SHUTDOWN</button>
                    <button class="dos-button" id="testBtn" onclick="testOCR()" disabled>[F4] TEST OCR</button>
                    <button class="dos-button" id="testAgeBtn" onclick="testAgeVerification()">[F5] TEST AGE</button>
                </div>
                
                <div class="mobile-controls" id="mobileControls">
                    <button class="dos-button mobile-btn" id="mobileStartBtn" onclick="startSystem()">üì± START CAMERA</button>
                    <button class="dos-button mobile-btn" id="mobileScanBtn" onclick="toggleScanning()" disabled>üì∑ SCAN ID CARD</button>
                    <button class="dos-button mobile-btn" id="mobileStopBtn" onclick="stopSystem()" disabled>‚èπÔ∏è STOP</button>
                    <button class="dos-button mobile-btn" id="mobileTestBtn" onclick="testOCR()" disabled>üîß TEST OCR</button>
                    <button class="dos-button mobile-btn" id="mobileTestAgeBtn" onclick="testAgeVerification()">üß™ TEST AGE</button>
                </div>
                
                <div class="camera-tips" id="cameraTips">
                    <div class="dos-title">> ID CARD SCANNING TIPS</div>
                    <div class="tip-item">üì∑ Position FRONT of ID card</div>
                    <div class="tip-item">üí° Good lighting on text</div>
                    <div class="tip-item">üìè Fill screen with ID card</div>
                    <div class="tip-item">‚ö° Avoid glare on text</div>
                    <div class="tip-item">üì± Keep text sharp and clear</div>
                    <div class="tip-item">üîç Focus on Date of Birth</div>
                </div>
                
                <div class="dos-terminal" id="terminal">
                    ID CARD AGE VERIFICATION SYSTEM v1.0
                    =====================================
                    > System Ready...
                    > Waiting for initialization...
                    > 
                </div>
            </div>
            
            <div class="dos-right">
                <div class="dos-title">> VERIFICATION RESULTS</div>
                
                <div class="age-result age-unknown" id="ageResult">
                    <div>[ NO DATA RECEIVED ]</div>
                    <div>SCAN FRONT OF ID CARD</div>
                </div>
                
                <div class="dos-info" id="personInfo" style="display: none;">
                    <div class="dos-info-item">
                        <span class="dos-label">NAME:</span>
                        <span class="dos-value" id="personName">-</span>
                    </div>
                    <div class="dos-info-item">
                        <span class="dos-label">AGE:</span>
                        <span class="dos-value" id="personAge">-</span>
                    </div>
                    <div class="dos-info-item">
                        <span class="dos-label">BIRTH DATE:</span>
                        <span class="dos-value" id="personDOB">-</span>
                    </div>
                    <div class="dos-info-item">
                        <span class="dos-label">LICENSE #:</span>
                        <span class="dos-value" id="personDLN">-</span>
                    </div>
                    <div class="dos-info-item">
                        <span class="dos-label">EXPIRES:</span>
                        <span class="dos-value" id="personEXP">-</span>
                    </div>
                    <div class="dos-info-item">
                        <span class="dos-label">STATUS:</span>
                        <span class="dos-value" id="personStatus">-</span>
                    </div>
                </div>
                
                <div class="dos-terminal" id="resultTerminal" style="margin-top: 10px;">
                    VERIFICATION LOG
                    ================
                    > Ready for scan...
                    > 
                </div>
            </div>
        </div>
    </div>

    <script>
        let stream = null;
        let isScanning = false;
        let frameCount = 0;
        let isMobile = false;
        let ocrWorker = null;
        
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const placeholder = document.getElementById('placeholder');
        const scanLine = document.getElementById('scanLine');
        const terminal = document.getElementById('terminal');
        const resultTerminal = document.getElementById('resultTerminal');
        const status = document.getElementById('status');
        const ageResult = document.getElementById('ageResult');
        const personInfo = document.getElementById('personInfo');
        
        // Detect mobile device
        function detectMobile() {
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            return isMobile;
        }
        
        // Play success beep sound
        function playSuccessBeep() {
            try {
                const beep = document.getElementById('successBeep');
                if (beep) {
                    beep.currentTime = 0;
                    beep.play().catch(e => console.log('Could not play beep:', e));
                }
            } catch (error) {
                console.log('Beep error:', error);
            }
        }
        
        // Initialize OCR worker
        async function initializeOCR() {
            try {
                addTerminal('> Loading OCR library...', 'loading');
                
                // Check if Tesseract is available
                if (typeof Tesseract === 'undefined') {
                    throw new Error('Tesseract library not loaded');
                }
                
                addTerminal('> Creating OCR worker...', 'loading');
                ocrWorker = await Tesseract.createWorker('eng', 1, {
                    logger: (m) => {
                        if (m.status === 'recognizing text') {
                            addTerminal(`> OCR Progress: ${Math.round(m.progress * 100)}%`, 'info');
                        }
                    }
                });
                
                addTerminal('> OCR worker created', 'success');
                
                // Skip complex configuration for now to avoid issues
                addTerminal('> OCR engine initialized successfully', 'success');
                return true;
                
            } catch (error) {
                addTerminal(`> OCR initialization failed: ${error.message}`, 'error');
                
                // Try to create a simple fallback
                try {
                    addTerminal('> Trying OCR fallback...', 'loading');
                    ocrWorker = await Tesseract.createWorker('eng');
                    addTerminal('> OCR fallback worked!', 'success');
                    return true;
                } catch (fallbackError) {
                    addTerminal(`> OCR fallback failed: ${fallbackError.message}`, 'error');
                    return false;
                }
            }
        }
        
        // Test barcode detection with visual feedback
        function testBarcodeDetection() {
            addTerminal('> TEST BUTTON CLICKED!', 'success');
            
            if (!video || !video.videoWidth) {
                addTerminal('> ERROR: Camera not active or video not ready', 'error');
                addTerminal('> Video element exists: ' + (video ? 'YES' : 'NO'), 'info');
                addTerminal('> Video width: ' + (video ? video.videoWidth : 'N/A'), 'info');
                return;
            }
            
            addTerminal('> Testing barcode detection...', 'loading');
            
            try {
                // Capture a single frame
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                addTerminal(`> Test frame: ${canvas.width}x${canvas.height}px`, 'info');
                addTerminal(`> Image data: ${imageData.data.length} pixels`, 'info');
                
                // Try all detection methods for testing
                let found = false;
                
                // Method 1: Standard reader
                try {
                    const result = codeReader.decodeFromImageData(imageData);
                    if (result) {
                        addTerminal(`> TEST SUCCESS: Barcode found!`, 'success');
                        addTerminal(`> Format: ${result.getBarcodeFormat()}`, 'info');
                        addTerminal(`> Length: ${result.getText().length} chars`, 'info');
                        addTerminal(`> Preview: ${result.getText().substring(0, 50)}...`, 'info');
                        playSuccessBeep();
                        found = true;
                    }
                } catch (error) {
                    addTerminal(`> Method 1: No barcode - ${error.message}`, 'info');
                }
                
                // Method 2: PDF417 reader
                if (!found) {
                    try {
                        const pdf417Reader = new ZXing.PDF417Reader();
                        const result = pdf417Reader.decode(imageData);
                        if (result && result.length > 20) {
                            addTerminal(`> TEST SUCCESS: PDF417 found!`, 'success');
                            addTerminal(`> Length: ${result.length} chars`, 'info');
                            addTerminal(`> Preview: ${result.substring(0, 50)}...`, 'info');
                            playSuccessBeep();
                            found = true;
                        }
                    } catch (error) {
                        addTerminal(`> Method 2: No PDF417 - ${error.message}`, 'info');
                    }
                }
                
                // Method 3: With hints
                if (!found) {
                    try {
                        const hints = new Map();
                        hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                        const codeReaderWithHints = new ZXing.BrowserMultiFormatReader();
                        codeReaderWithHints.hints = hints;
                        
                        const result = codeReaderWithHints.decodeFromImageData(imageData);
                        if (result) {
                            addTerminal(`> TEST SUCCESS: Found with hints!`, 'success');
                            addTerminal(`> Format: ${result.getBarcodeFormat()}`, 'info');
                            addTerminal(`> Length: ${result.getText().length} chars`, 'info');
                            addTerminal(`> Preview: ${result.getText().substring(0, 50)}...`, 'info');
                            playSuccessBeep();
                            found = true;
                        }
                    } catch (error) {
                        addTerminal(`> Method 3: No barcode with hints - ${error.message}`, 'info');
                    }
                }
                
                if (!found) {
                    addTerminal(`> TEST RESULT: No barcode detected in current frame`, 'warning');
                    addTerminal(`> VISUAL DEBUG: Creating snapshot...`, 'info');
                    
                    // Show visual debug image
                    showDebugImage(canvas.toDataURL('image/jpeg', 0.8));
                    
                    addTerminal(`> Tips:`, 'info');
                    addTerminal(`> - Ensure PDF417 barcode is visible`, 'info');
                    addTerminal(`> - Fill screen with barcode`, 'info');
                    addTerminal(`> - Good lighting, no glare`, 'info');
                    addTerminal(`> - Hold camera steady`, 'info');
                    addTerminal(`> - Check debug image (top-right)`, 'info');
                    addTerminal(`> - PDF417 is on BACK of driver's license`, 'info');
                    addTerminal(`> - Should look like a stacked barcode pattern`, 'info');
                }
            } catch (error) {
                addTerminal(`> TEST ERROR: ${error.message}`, 'error');
                addTerminal(`> Error details: ${error.stack}`, 'error');
            }
        }
        
        // Debug function to show captured image
        function showDebugImage(imageData) {
            try {
                const debugDiv = document.createElement('div');
                debugDiv.style.position = 'fixed';
                debugDiv.style.top = '10px';
                debugDiv.style.right = '10px';
                debugDiv.style.zIndex = '9999';
                debugDiv.style.background = '#000000';
                debugDiv.style.border = '2px solid #00ff00';
                debugDiv.style.padding = '10px';
                debugDiv.style.maxWidth = '200px';
                debugDiv.style.borderRadius = '8px';
                debugDiv.style.boxShadow = '0 0 20px #00ff00';
                
                const img = document.createElement('img');
                img.src = imageData;
                img.style.width = '100%';
                img.style.height = 'auto';
                img.style.borderRadius = '4px';
                img.style.border = '1px solid #00ff00';
                
                const title = document.createElement('div');
                title.textContent = 'üîç CAMERA VIEW';
                title.style.fontFamily = 'VT323, monospace';
                title.style.fontWeight = 'bold';
                title.style.marginBottom = '5px';
                title.style.fontSize = '14px';
                title.style.color = '#00ff00';
                title.style.textAlign = 'center';
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'CLOSE';
                closeBtn.style.marginTop = '5px';
                closeBtn.style.width = '100%';
                closeBtn.style.padding = '5px';
                closeBtn.style.fontSize = '12px';
                closeBtn.style.fontFamily = 'VT323, monospace';
                closeBtn.style.background = '#000000';
                closeBtn.style.color = '#00ff00';
                closeBtn.style.border = '1px solid #00ff00';
                closeBtn.style.cursor = 'pointer';
                closeBtn.onclick = () => document.body.removeChild(debugDiv);
                
                debugDiv.appendChild(title);
                debugDiv.appendChild(img);
                debugDiv.appendChild(closeBtn);
                document.body.appendChild(debugDiv);
                
                addTerminal('> Debug image shown (top-right corner)', 'success');
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (document.body.contains(debugDiv)) {
                        document.body.removeChild(debugDiv);
                        addTerminal('> Debug image auto-removed', 'info');
                    }
                }, 10000);
            } catch (error) {
                addTerminal(`> Debug image failed: ${error.message}`, 'error');
            }
        }
        
        // Test OCR with current frame
        async function testOCR() {
            // Only allow OCR testing on mobile devices
            if (!isMobile) {
                addTerminal('> ERROR: OCR testing only available on mobile devices', 'error');
                addResultTerminal('> Please use mobile device for ID scanning', 'error');
                return;
            }
            
            if (!video || !video.videoWidth) {
                addTerminal('> ERROR: Camera not active', 'error');
                return;
            }
            
            addTerminal('> TESTING OCR...', 'loading');
            
            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                addTerminal(`> Captured frame: ${canvas.width}x${canvas.height}px`, 'info');
                
                const { data: { text } } = await ocrWorker.recognize(imageData);
                addTerminal(`> OCR Result: "${text.substring(0, 200)}..."`, 'info');
                
                // Look for any dates
                const dateMatch = text.match(/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/);
                if (dateMatch) {
                    addTerminal(`> Date found: ${dateMatch[0]}`, 'success');
                    const ageInfo = calculateAge(dateMatch[0]);
                    addTerminal(`> Age: ${ageInfo.age} | 21+: ${ageInfo.isOver21 ? 'YES' : 'NO'}`, 'info');
                } else {
                    addTerminal('> No dates found in text', 'warning');
                }
                
                // Test with a sample date if no dates found
                if (!dateMatch) {
                    addTerminal('> Testing with sample date: 01/15/1995', 'info');
                    const testAgeInfo = calculateAge('01/15/1995');
                    addTerminal(`> Sample Age: ${testAgeInfo.age} | 21+: ${testAgeInfo.isOver21 ? 'YES' : 'NO'}`, 'info');
                }
                
            } catch (error) {
                addTerminal(`> OCR Error: ${error.message}`, 'error');
            }
        }
        
        // Manual test with known dates
        function testAgeVerification() {
            addTerminal('> TESTING AGE VERIFICATION...', 'loading');
            
            const testDates = [
                '01/15/1995', // 29 years old - 21+
                '12/01/2005', // 19 years old - Under 21
                '06/30/2002', // 22 years old - 21+
                '08/15/2008'  // 16 years old - Under 21
            ];
            
            testDates.forEach(date => {
                const ageInfo = calculateAge(date);
                addTerminal(`> ${date} ‚Üí Age: ${ageInfo.age} | 21+: ${ageInfo.isOver21 ? 'YES' : 'NO'}`, 'info');
            });
            
            addTerminal('> Age verification test complete', 'success');
        }
        
        // Update mobile button states
        function updateMobileButtons() {
            const mobileStartBtn = document.getElementById('mobileStartBtn');
            const mobileScanBtn = document.getElementById('mobileScanBtn');
            const mobileStopBtn = document.getElementById('mobileStopBtn');
            const mobileTestBtn = document.getElementById('mobileTestBtn');
            
            const desktopStartBtn = document.getElementById('startBtn');
            const desktopScanBtn = document.getElementById('scanBtn');
            const desktopStopBtn = document.getElementById('stopBtn');
            const desktopTestBtn = document.getElementById('testBtn');
            
            if (isMobile) {
                // Sync mobile buttons with desktop button states
                mobileStartBtn.disabled = desktopStartBtn.disabled;
                mobileScanBtn.disabled = desktopScanBtn.disabled;
                mobileStopBtn.disabled = desktopStopBtn.disabled;
                mobileTestBtn.disabled = desktopStartBtn.disabled; // Test button needs camera, but not scanning
                
                // Update mobile button text
                if (isScanning) {
                    mobileScanBtn.textContent = '‚èπÔ∏è STOP SCANNING';
                } else {
                    mobileScanBtn.textContent = 'üì∑ SCAN ID';
                }
            }
            
            // Update desktop test button
            if (desktopTestBtn) {
                desktopTestBtn.disabled = desktopStartBtn.disabled;
            }
        }
        
        function addTerminal(message, type = 'normal') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error-text' : type === 'success' ? 'success-text' : type === 'loading' ? 'loading-text' : '';
            terminal.innerHTML += `\n[${timestamp}] ${message}`;
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function addResultTerminal(message, type = 'normal') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error-text' : type === 'success' ? 'success-text' : '';
            resultTerminal.innerHTML += `\n[${timestamp}] ${message}`;
            resultTerminal.scrollTop = resultTerminal.scrollHeight;
        }
        
        function updateStatus(newStatus) {
            status.textContent = newStatus;
            addTerminal(`STATUS: ${newStatus}`);
        }
        
        async function startSystem() {
            try {
                addTerminal('> === CAMERA DEBUG START ===', 'loading');
                addTerminal('> Starting system...', 'loading');
                updateStatus('INITIALIZING...');
                
                // Disable buttons immediately
                const startBtn = document.getElementById('startBtn');
                const mobileStartBtn = document.getElementById('mobileStartBtn');
                
                addTerminal(`> Start button found: ${!!startBtn}`, 'info');
                addTerminal(`> Mobile start button found: ${!!mobileStartBtn}`, 'info');
                
                startBtn.disabled = true;
                if (mobileStartBtn) mobileStartBtn.disabled = true;
                
                addTerminal('> Buttons disabled', 'info');
                
                // Test browser support
                addTerminal('> Checking browser support...', 'info');
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera not supported in this browser');
                }
                addTerminal('> Browser supports camera', 'success');
                
                // Test OCR
                addTerminal('> Initializing OCR...', 'loading');
                let ocrReady = false;
                try {
                    ocrReady = await initializeOCR();
                    if (ocrReady) {
                        addTerminal('> OCR ready', 'success');
                    } else {
                        addTerminal('> OCR failed, but continuing with camera only...', 'warning');
                        addTerminal('> You can test camera, but scanning will not work', 'warning');
                    }
                } catch (ocrError) {
                    addTerminal('> OCR failed completely, but continuing with camera...', 'warning');
                    addTerminal('> OCR Error: ' + ocrError.message, 'warning');
                    ocrReady = false;
                }
                
                // Test camera access
                addTerminal('> Requesting camera access...', 'loading');
                
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
                
                addTerminal(`> Camera constraints: ${JSON.stringify(constraints)}`, 'info');
                
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    addTerminal('> Camera access granted!', 'success');
                } catch (cameraError) {
                    addTerminal(`> Camera access failed: ${cameraError.name}`, 'error');
                    addTerminal(`> Camera error: ${cameraError.message}`, 'error');
                    
                    // Try fallback constraints
                    addTerminal('> Trying fallback camera settings...', 'loading');
                    const fallbackConstraints = {
                        video: true
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    addTerminal('> Fallback camera worked!', 'success');
                }
                
                // Setup video
                addTerminal('> Setting up video element...', 'info');
                const video = document.getElementById('video');
                const placeholder = document.getElementById('placeholder');
                
                addTerminal('> Video element found: ' + !!video, 'info');
                addTerminal('> Placeholder element found: ' + !!placeholder, 'info');
                
                video.srcObject = stream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
                // Wait for video to load
                addTerminal('> Waiting for video to load...', 'loading');
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        addTerminal(`> Video loaded: ${video.videoWidth}x${video.videoHeight}`, 'success');
                        resolve();
                    };
                });
                
                // Enable buttons
                updateStatus('CAMERA READY');
                document.getElementById('scanBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('testBtn').disabled = false;
                
                updateMobileButtons();
                
                addTerminal('> === CAMERA DEBUG SUCCESS ===', 'success');
                addTerminal('> Camera ready for scanning!', 'success');
                
            } catch (error) {
                updateStatus('ERROR');
                addTerminal(`> === CAMERA DEBUG ERROR ===`, 'error');
                addTerminal(`> ERROR: ${error.message}`, 'error');
                addTerminal(`> ERROR TYPE: ${error.name}`, 'error');
                addTerminal(`> ERROR STACK: ${error.stack}`, 'error');
                
                // Re-enable start button
                document.getElementById('startBtn').disabled = false;
                const mobileStartBtn = document.getElementById('mobileStartBtn');
                if (mobileStartBtn) mobileStartBtn.disabled = false;
                
                updateMobileButtons();
            }
        }
        
        function toggleScanning() {
            addTerminal('> SCAN BUTTON CLICKED!', 'success');
            
            if (isScanning) {
                addTerminal('> Stopping scanning...', 'info');
                stopScanning();
            } else {
                addTerminal('> Starting scanning...', 'info');
                startScanning();
            }
        }
        
        function startScanning() {
            addTerminal('> DEBUG: Starting scan function...', 'info');
            addTerminal(`> DEBUG: OCR Worker exists: ${!!ocrWorker}`, 'info');
            addTerminal(`> DEBUG: Stream exists: ${!!stream}`, 'info');
            addTerminal(`> DEBUG: Video ready: ${!!video && !!video.videoWidth}`, 'info');
            addTerminal(`> DEBUG: Is mobile: ${isMobile}`, 'info');
            
            // Only allow scanning on mobile devices
            if (!isMobile) {
                addTerminal('> ERROR: Age verification only available on mobile devices', 'error');
                addResultTerminal('> Please use mobile device for ID scanning', 'error');
                return;
            }
            
            // Check if OCR is available
            if (!ocrWorker) {
                addTerminal('> ERROR: OCR not available - camera only mode', 'error');
                addResultTerminal('> OCR failed to initialize - restart app', 'error');
                return;
            }
            
            if (!stream) {
                addTerminal('> ERROR: System not initialized', 'error');
                addTerminal('> - Camera stream not ready', 'error');
                return;
            }
            
            addTerminal('> DEBUG: All checks passed, starting scan...', 'success');
            
            isScanning = true;
            scanLine.style.display = 'block';
            document.getElementById('scanBtn').textContent = '[F2] STOP SCANNING';
            updateStatus('SCANNING...');
            
            updateMobileButtons();
            
            addTerminal('> Starting ID card OCR scanning...', 'loading');
            addResultTerminal('> Scan initiated...', 'loading');
            
            addTerminal('> Mobile OCR mode active', 'info');
            addResultTerminal('> Position ID card clearly...', 'info');
            
            frameCount = 0;
            addTerminal('> DEBUG: Calling scanFrame...', 'info');
            scanFrame();
        }
        
        function stopScanning() {
            isScanning = false;
            scanLine.style.display = 'none';
            document.getElementById('scanBtn').textContent = '[F2] SCAN ID CARD';
            updateStatus('CAMERA READY');
            
            updateMobileButtons();
            
            addTerminal('> OCR scanning stopped');
            addResultTerminal('> Scan terminated');
        }
        
        async function scanFrame() {
            if (!isScanning) return;
            
            frameCount++;
            
            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                // Run OCR every 10 frames instead of 30 for better detection
                if (frameCount % 10 === 0) {
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    addTerminal(`> OCR scanning frame ${frameCount}...`, 'loading');
                    
                    try {
                        const { data: { text } } = await ocrWorker.recognize(imageData);
                        addTerminal(`> OCR Text: "${text.substring(0, 100)}..."`, 'info');
                        
                        // Look for date of birth with multiple patterns
                        let dob = null;
                        
                        // Pattern 1: DOB labels
                        const dobPatterns = [
                            /(?:DOB|Date of Birth|Birth|Born|Birthdate|B\.O\.D\.)[:\s]*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i,
                            /(?:Date\s*of\s*Birth|Birth\s*Date)[:\s]*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i,
                            /(?:Born|Birth)[:\s]*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i
                        ];
                        
                        for (const pattern of dobPatterns) {
                            const match = text.match(pattern);
                            if (match) {
                                dob = match[1];
                                addTerminal(`> DOB found: ${dob}`, 'success');
                                break;
                            }
                        }
                        
                        // Pattern 2: Look for any date that could be a birth date
                        if (!dob) {
                            const allDates = text.match(/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/g);
                            if (allDates && allDates.length > 0) {
                                addTerminal(`> Found dates: ${allDates.join(', ')}`, 'info');
                                // Try the first few dates to see if any make sense as birth dates
                                for (const date of allDates.slice(0, 3)) {
                                    const ageInfo = calculateAge(date);
                                    if (ageInfo.age && ageInfo.age > 15 && ageInfo.age < 100) {
                                        dob = date;
                                        addTerminal(`> Likely birth date: ${dob} (age ${ageInfo.age})`, 'success');
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Pattern 3: Look for common ID card formats
                        if (!dob) {
                            const agePattern = /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})\s.*?(?:age|years|y\/o)/i;
                            const ageMatch = text.match(agePattern);
                            if (ageMatch) {
                                dob = ageMatch[1];
                                addTerminal(`> Birth date with age indicator: ${dob}`, 'success');
                            }
                        }
                        
                        if (dob) {
                            addTerminal(`> Processing DOB: ${dob}`, 'success');
                            const ageInfo = calculateAge(dob);
                            
                            addTerminal(`> Age: ${ageInfo.age} | 21+: ${ageInfo.isOver21 ? 'YES' : 'NO'}`, 'info');
                            
                            displayAgeResult(ageInfo);
                            playSuccessBeep();
                            stopScanning();
                            return;
                        } else {
                            addTerminal('> No DOB found, continuing scan...', 'warning');
                        }
                        
                    } catch (ocrError) {
                        addTerminal(`> OCR error: ${ocrError.message}`, 'warning');
                    }
                }
                
                // Show progress less frequently
                if (frameCount % 15 === 0) {
                    addTerminal(`> Scanning frame ${frameCount}...`, 'loading');
                }
                
                requestAnimationFrame(scanFrame);
                
            } catch (error) {
                addTerminal(`> Frame error: ${error.message}`, 'error');
                requestAnimationFrame(scanFrame);
            }
        }
        
        // Calculate age from date string
        function calculateAge(dateString) {
            try {
                let cleaned = dateString.replace(/[^\d\/\-]/g, '');
                
                let month, day, year;
                
                if (cleaned.includes('/')) {
                    const parts = cleaned.split('/');
                    if (parts.length === 3) {
                        month = parseInt(parts[0]);
                        day = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                    }
                } else if (cleaned.includes('-')) {
                    const parts = cleaned.split('-');
                    if (parts.length === 3) {
                        month = parseInt(parts[0]);
                        day = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                    }
                }
                
                // Basic validation
                if (!month || !day || !year || month < 1 || month > 12 || day < 1 || day > 31) {
                    return { age: 'INVALID', isOver21: false, formattedDate: dateString };
                }
                
                // Handle 2-digit years
                if (year < 100) {
                    year += year < 50 ? 2000 : 1900;
                }
                
                // Validate year range
                const currentYear = new Date().getFullYear();
                if (year < 1900 || year > currentYear) {
                    return { age: 'INVALID', isOver21: false, formattedDate: dateString };
                }
                
                const birthDate = new Date(year, month - 1, day);
                const today = new Date();
                
                // Check if date is valid
                if (birthDate.getMonth() !== month - 1 || birthDate.getDate() !== day) {
                    return { age: 'INVALID', isOver21: false, formattedDate: dateString };
                }
                
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                const isOver21 = age >= 21;
                const formattedDate = `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}/${year}`;
                
                return {
                    age: age,
                    isOver21: isOver21,
                    formattedDate: formattedDate
                };
                
            } catch (error) {
                return { age: 'ERROR', isOver21: false, formattedDate: dateString };
            }
        }
        
        // Display age verification result
        function displayAgeResult(ageInfo) {
            document.getElementById('personAge').textContent = ageInfo.age;
            document.getElementById('personDOB').textContent = ageInfo.formattedDate;
            document.getElementById('personName').textContent = 'ID CARD HOLDER';
            document.getElementById('personDLN').textContent = 'EXTRACTED FROM ID';
            document.getElementById('personEXP').textContent = 'N/A';
            
            let status, statusClass, resultHtml, statusText;
            
            if (ageInfo.age === 'INVALID' || ageInfo.age === 'ERROR') {
                status = 'ERROR';
                statusClass = 'age-denied';
                resultHtml = `
                    <div>[ VERIFICATION ERROR ]</div>
                    <div>INVALID DATE FORMAT</div>
                    <div>PLEASE TRY AGAIN ‚úó</div>
                `;
                statusText = 'ERROR: INVALID DATE';
                addTerminal(`> VERIFICATION ERROR: Invalid date format`, 'error');
                addResultTerminal(`> Please scan ID card again`, 'error');
            } else if (ageInfo.isOver21) {
                status = 'VERIFIED: 21+';
                statusClass = 'age-verified';
                const yearsOver = ageInfo.age - 21;
                resultHtml = `
                    <div>[ AGE VERIFIED ]</div>
                    <div>${ageInfo.age} YEARS OLD</div>
                    <div>21+ - APPROVED ‚úì</div>
                    <div>${yearsOver} YEAR${yearsOver !== 1 ? 'S' : ''} OVER 21</div>
                `;
                statusText = '21+ APPROVED';
                addTerminal(`> ‚úì AGE VERIFIED: ${ageInfo.age} years old (21+)`, 'success');
                addResultTerminal(`> ‚úì ACCESS GRANTED: Age ${ageInfo.age} - 21+ APPROVED`, 'success');
            } else {
                status = 'DENIED: UNDER 21';
                statusClass = 'age-denied';
                const yearsTo21 = 21 - ageInfo.age;
                resultHtml = `
                    <div>[ ACCESS DENIED ]</div>
                    <div>${ageInfo.age} YEARS OLD</div>
                    <div>UNDER 21 - REJECTED ‚úó</div>
                    <div>${yearsTo21} YEAR${yearsTo21 !== 1 ? 'S' : ''} TO 21</div>
                `;
                statusText = 'UNDER 21';
                addTerminal(`> ‚úó ACCESS DENIED: ${ageInfo.age} years old (Under 21)`, 'error');
                addResultTerminal(`> ‚úó ACCESS DENIED: Under 21 - ${yearsTo21} year${yearsTo21 !== 1 ? 's' : ''} to 21`, 'error');
            }
            
            document.getElementById('personStatus').textContent = statusText;
            personInfo.style.display = 'block';
            
            ageResult.className = `age-result ${statusClass}`;
            ageResult.innerHTML = resultHtml;
            updateStatus(status);
            
            addTerminal('> Verification complete', 'success');
        }
        
        function addTerminal(message, type = 'normal') {
            const timestamp = new Date().toLocaleTimeString();
            terminal.innerHTML += `\n[${timestamp}] ${message}`;
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function addResultTerminal(message, type = 'normal') {
            const timestamp = new Date().toLocaleTimeString();
            resultTerminal.innerHTML += `\n[${timestamp}] ${message}`;
            resultTerminal.scrollTop = resultTerminal.scrollHeight;
        }
        
        function updateStatus(newStatus) {
            status.textContent = newStatus;
            addTerminal(`STATUS: ${newStatus}`);
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (event.key === 'F1') {
                event.preventDefault();
                startSystem();
            } else if (event.key === 'F2') {
                event.preventDefault();
                toggleScanning();
            } else if (event.key === 'F3') {
                event.preventDefault();
                stopSystem();
            } else if (event.key === 'F4') {
                event.preventDefault();
                testOCR();
            } else if (event.key === 'F5') {
                event.preventDefault();
                testAgeVerification();
            }
        });
        
        // Initialize mobile detection and setup
        window.addEventListener('load', () => {
            detectMobile();
            
            if (isMobile) {
                addTerminal('> Mobile device detected');
                addTerminal('> Touch controls enabled');
                addTerminal('> Optimized for ID card scanning');
                addResultTerminal('> Mobile mode ready');
                addResultTerminal('> Use touch buttons below');
            } else {
                addTerminal('> Desktop detected');
                addTerminal('> Age verification available on mobile only');
                addResultTerminal('> Use mobile device for ID scanning');
            }
            
            addTerminal('> ID CARD AGE VERIFICATION SYSTEM v1.0');
            addTerminal('> Copyright (C) Written by Daryle Walton JR');
            
            if (isMobile) {
                addTerminal('> Touch üì± START CAMERA to begin');
            } else {
                addTerminal('> Press F1 to initialize system');
            }
            
            addResultTerminal('> Verification system ready');
        });
    </script>
</body>
</html>
                if (year < 100) {
                    year += year < 50 ? 2000 : 1900;
                }
                
                const birthDate = new Date(year, month - 1, day);
                const today = new Date();
                
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return {
                    age: age,
                    isOver21: age >= 21,
                    formattedDate: `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}/${year}`
                };
                
            } catch (error) {
                return {
                    age: 'UNKNOWN',
                    isOver21: false,
                    formattedDate: dateString
                };
            }
        }
        
        function stopSystem() {
            stopScanning();
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                video.style.display = 'none';
                placeholder.style.display = 'block';
                stream = null;
            }
            
            if (ocrWorker) {
                ocrWorker.terminate();
                ocrWorker = null;
            }
            
            updateStatus('SYSTEM OFFLINE');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            
            updateMobileButtons();
            
            addTerminal('> System shutdown complete');
            addResultTerminal('> System offline');
        }
        
        // Initialize mobile detection and setup
        window.addEventListener('load', () => {
            detectMobile();
            
            if (isMobile) {
                addTerminal('> Mobile device detected');
                addTerminal('> Touch controls enabled');
                addTerminal('> Optimized for phone scanning');
                addResultTerminal('> Mobile mode ready');
                addResultTerminal('> Use touch buttons below');
            } else {
                addTerminal('> Desktop detected');
                addTerminal('> Keyboard shortcuts available');
                addResultTerminal('> Use F1-F3 keys or buttons');
            }
            
            addTerminal('> PDF417 AGE VERIFICATION SYSTEM v1.0');
            addTerminal('> Copyright (C) Written by Daryle Walton JR');
            
            if (isMobile) {
                addTerminal('> Touch üì± START CAMERA to begin');
            } else {
                addTerminal('> Press F1 to initialize system');
            }
            
            addResultTerminal('> Verification system ready');
        });
    </script>
</body>
</html>